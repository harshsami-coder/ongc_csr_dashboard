<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ONGC CSR Spending Dashboard (2024-25)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Leaflet.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{ --bg:#0b1220; --panel:#1c2635; --ink:#e8edf6; --muted:#9aa6b2; --accent:#f3c623; --panel-radius:14px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:18px 12px;text-align:center;border-bottom:1px solid #2a3546}
    header h1{margin:0;font-size:1.4rem;font-weight:700;letter-spacing:.2px}
    header .sub{opacity:.7;font-size:.9rem;margin-top:4px}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .kpis{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
    .kpi{background:var(--panel);border-radius:var(--panel-radius);padding:16px 18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .kpi .val{font-size:1.6rem;font-weight:800;color:var(--accent)}
    .kpi .label{margin-top:6px;color:var(--muted);font-weight:600}
    .row{display:grid;gap:16px;margin-top:16px}
    @media(min-width:1000px){ .row{grid-template-columns:1.1fr 1fr} }
    .panel{background:var(--panel);border-radius:var(--panel-radius);padding:14px 14px 10px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .panel h3{margin:0 0 10px;font-size:1rem;font-weight:700}
    select{appearance:none;padding:10px 12px;border-radius:10px;border:1px solid #2a3546;background:#182030;color:var(--ink);min-width:220px}
    .controls{display:flex;gap:10px;align-items:center;margin:8px 0 0 0}
    .chart-box{position:relative;height:320px}   /* bigger donut */
    .chart-box.tall{height:360px}
    canvas{max-width:100% !important}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid #2a3546;text-align:left;white-space:nowrap}
    th{position:sticky;top:0;background:#162034;z-index:1}
    .scroll{max-height:300px;overflow:auto;border:1px solid #2a3546;border-radius:10px}
    #map{height:360px;border-radius:12px;margin-top:8px}
    .footnote{margin-top:10px;color:#8fa2b5;text-align:center;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>ONGC CSR Spending Dashboard (2024-25)</h1>
    <div class="sub">Minimal, sleek view — data from <code>csr_data.csv</code></div>
  </header>

  <div class="wrap">
    <section class="kpis">
      <div class="kpi"><div id="kpiTotal" class="val">₹ 0.0000</div><div class="label">Total Amount Spent</div></div>
      <div class="kpi"><div id="kpiProjects" class="val">0</div><div class="label">No. of CSR Projects</div></div>
      <div class="kpi"><div id="kpiEnv" class="val">₹ 0.0000</div><div class="label">Environment Spend</div></div>
      <div class="kpi"><div id="kpiEnvShare" class="val">0%</div><div class="label">Environment Share of Total</div></div>
    </section>

    <div class="panel" style="margin-top:16px">
      <h3>Filter</h3>
      <div class="controls">
        <label for="stateSel">By State:&nbsp;</label>
        <select id="stateSel"><option value="__ALL__">All States</option></select>
      </div>
    </div>

    <section class="row">
      <div class="panel">
        <h3>Spending by Sector</h3>
        <div class="chart-box"><canvas id="sectorChart"></canvas></div>
      </div>
      <div class="panel">
        <h3>Spending by State</h3>
        <div class="chart-box tall"><canvas id="stateChart"></canvas></div>
      </div>
    </section>

    <section class="row" style="margin-top:16px">
      <div class="panel">
        <h3>CSR Spending by State (Table)</h3>
        <div class="scroll">
          <table id="stateTable">
            <thead><tr><th>State / UT</th><th>Amount (₹ Cr)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="panel">
        <h3>Spending Map</h3>
        <div id="map"></div>
        <div class="footnote">PAN INDIA & MULTI STATE are included in visuals.</div>
      </div>
    </section>
  </div>

  <script>
    let sectorChart, stateChart, map, markers = [];

    const fmtMoney = v => `₹ ${Number(v).toFixed(4)}`;
    const toNum = s => (typeof s === 'number') ? s : (parseFloat(String(s||'0').replace(/[^0-9.\-]/g,'')) || 0);
    const norm = s => String(s||'').trim();

    const COORDS = {
      "ANDHRA PRADESH":[15.91,79.74],"DELHI":[28.61,77.23],"MAHARASHTRA":[19.07,72.87],"GUJARAT":[22.3,70.8],
      "UTTAR PRADESH":[26.8,80.9],"TAMIL NADU":[13.08,80.27],"KARNATAKA":[12.97,77.59],"JAMMU AND KASHMIR":[33.78,76.57],
      "ASSAM":[26.2,92.9],"PUNJAB":[31.1,75.3],"JHARKHAND":[23.61,85.28],"TELANGANA":[17.38,78.48],"KERALA":[9.93,76.27],
      "BIHAR":[25.6,85.1],"UTTARAKHAND":[30.32,78.03],"RAJASTHAN":[26.9,75.8],"ODISHA":[20.27,85.84],"WEST BENGAL":[22.57,88.36],
      "HARYANA":[28.46,77.02],"CHHATTISGARH":[21.25,81.63],"HIMACHAL PRADESH":[31.1,77.17],"TRIPURA":[23.84,91.28],
      "MADHYA PRADESH":[23.26,77.41],"GOA":[15.49,73.82],"NAGALAND":[26.16,94.56],"CHANDIGARH":[30.73,76.78],
      "MANIPUR":[24.81,93.94],"PAN INDIA":[22.97,78.65],"MULTI STATE":[21,82]
    };

    async function init() {
      const resp = await fetch('csr_data.csv');
      const csv = await resp.text();
      const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });

      const COL_STATE = parsed.meta.fields.find(h => h.toLowerCase().trim() === 'state');
      const COL_PROJ  = parsed.meta.fields.find(h => h.toLowerCase().trim().startsWith('project'));
      const COL_SECT  = parsed.meta.fields.find(h => h.toLowerCase().trim() === 'sector');
      const COL_AMT   = parsed.meta.fields.find(h => h.toLowerCase().includes('exp'));

      // Build raw rows
      const rawRows = parsed.data.map(r => ({
        state: norm(r[COL_STATE]).toUpperCase(),
        project: norm(r[COL_PROJ]),
        sector: norm(r[COL_SECT]),
        amount: toNum(r[COL_AMT])
      }));

      // KPIs
      const totalAmount   = rawRows.reduce((s,r)=>s+r.amount,0);
      const totalProjects = rawRows.length;
      const envTotal = rawRows.filter(r => r.sector.toLowerCase() === 'environment').reduce((s,r)=>s+r.amount,0);
      const envShare = totalAmount ? (envTotal/totalAmount*100) : 0;

      document.getElementById('kpiTotal').textContent = fmtMoney(totalAmount);
      document.getElementById('kpiProjects').textContent = totalProjects.toLocaleString('en-IN');
      document.getElementById('kpiEnv').textContent = fmtMoney(envTotal);
      document.getElementById('kpiEnvShare').textContent = `${envShare.toFixed(2)}%`;

      // Expand rows for visuals
      const data = [];
      rawRows.forEach(r => {
        if (r.state.includes('&')) {
          const parts = r.state.split('&').map(x => x.trim().toUpperCase());
          const share = r.amount / parts.length;
          parts.forEach(p => data.push({ state:p, sector:r.sector || 'Others', amount:share }));
        } else {
          data.push({ state:r.state, sector:r.sector || 'Others', amount:r.amount });
        }
      });

      // Populate state filter
      const stateSel = document.getElementById('stateSel');
      [...new Set(data.map(d=>d.state))].sort().forEach(st=>{
        const o=document.createElement('option'); o.value=st; o.textContent=st; stateSel.appendChild(o);
      });
      stateSel.addEventListener('change', ()=>{
        const val = stateSel.value;
        updateChartsAndTables(val==='__ALL__'? data : data.filter(d=>d.state===val));
      });

      // Map
      map = L.map('map').setView([22.97,78.65], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution:'&copy; OpenStreetMap &copy; CARTO' }).addTo(map);

      // Initial render
      updateChartsAndTables(data);
    }

    function updateChartsAndTables(rows){
      // Sector totals
      const sectorTotals = {};
      rows.forEach(d => sectorTotals[d.sector] = (sectorTotals[d.sector]||0) + d.amount);
      const total = Object.values(sectorTotals).reduce((a,b)=>a+b,0);

      // Donut chart
      if (sectorChart) sectorChart.destroy();
      sectorChart = new Chart(document.getElementById('sectorChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(sectorTotals),
          datasets: [{
            data: Object.values(sectorTotals),
            backgroundColor: ['#00c2ff','#28c76f','#ea5455','#f7b731','#9b59b6',
                              '#ff6b81','#54a0ff','#1dd1a1','#e17055','#ffeaa7',
                              '#a29bfe','#ff9f43'],
            borderColor: '#0b1220', borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#e8edf6',
                generateLabels: (chart) => {
                  const data = chart.data;
                  return data.labels.map((label, i) => {
                    const value = data.datasets[0].data[i];
                    const pct = total ? ((value/total)*100).toFixed(1) : 0;
                    return {
                      text: `${label} (${pct}%)`,
                      fillStyle: data.datasets[0].backgroundColor[i],
                      strokeStyle: '#0b1220',
                      lineWidth: 2
                    };
                  });
                }
              }
            },
            tooltip: { callbacks:{ label:(ctx)=>`${ctx.label}: ₹ ${ctx.raw.toFixed(2)} Cr` } }
          },
          cutout: '55%'   // thicker ring
        }
      });

      // State totals
      const stateTotals = {};
      rows.forEach(d => stateTotals[d.state] = (stateTotals[d.state]||0) + d.amount);
      const sorted = Object.entries(stateTotals).sort((a,b)=>b[1]-a[1]);

      if (stateChart) stateChart.destroy();
      stateChart = new Chart(document.getElementById('stateChart'), {
        type:'bar',
        data:{ labels:sorted.map(s=>s[0]), datasets:[{ label:'Amount (₹ Cr)', data:sorted.map(s=>s[1]), backgroundColor:'#4da3ff' }] },
        options:{
          indexAxis:'y',
          maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:(ctx)=>`₹ ${ctx.raw.toFixed(2)} Cr` }} },
          scales:{ x:{ticks:{color:'#e8edf6'}}, y:{ticks:{color:'#e8edf6'}} }
        }
      });

      // Table
      const tbody = document.querySelector('#stateTable tbody'); tbody.innerHTML='';
      sorted.forEach(([st,val])=>{
        const tr=document.createElement('tr'); tr.innerHTML=`<td>${st}</td><td>${val.toFixed(2)}</td>`; tbody.appendChild(tr);
      });

      // Map bubbles
      markers.forEach(m=>map.removeLayer(m)); markers=[];
      sorted.forEach(([st,val])=>{
        if (COORDS[st]){
          const circle = L.circleMarker(COORDS[st], {
            radius: Math.max(3, Math.sqrt(val)*0.6),
            fillColor:'#4da3ff', color:'#ffffff', weight:1, fillOpacity:0.7
          }).bindPopup(`<b>${st}</b><br/>₹ ${val.toFixed(2)} Cr`);
          circle.addTo(map); markers.push(circle);
        }
      });
    }

    init();
  </script>
</body>
</html>
